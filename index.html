<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Model Viewer</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: #111 url('pokemonBackground.gif') center / cover no-repeat;
    }

    #ui {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 10;
      color: #fff;
      font-family: system-ui, sans-serif;
      background: rgba(0,0,0,0.55);
      padding: 10px 12px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
    }

    #ui .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }

    #ui button {
      border: 0;
      border-radius: 8px;
      padding: 8px 10px;
      background: #2b2b2b;
      color: #fff;
      cursor: pointer;
    }

    canvas {
      position: absolute;
      inset: 0;
    }

    #msg {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      color: #ddd;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>

<body>
  <div id="ui">
    <div class="row">
      <button id="reset">Reset</button>
      <button id="toggleRotate">Rotate: OFF</button>
      <button id="toggleModel">Hide Model</button>
      <label>Speed <input id="speed" type="range" min="0" max="2" step="0.01" value="0.6"></label>
    </div>
  </div>

  <div id="msg">Loadingâ€¦</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    let MODEL_FILES = [];
    let currentModelIndex = 0;
    let currentSound = null;
    let showModel = true;
    let autoRotate = false;

    const msg = document.getElementById("msg");

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(55, innerWidth / innerHeight, 0.01, 2000);
    camera.position.set(2.5, 1.7, 2.5);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.2);
    dir.position.set(3, 6, 4);
    scene.add(dir);

    const loader = new THREE.GLTFLoader();
    const texLoader = new THREE.TextureLoader();

    const pivot = new THREE.Group(); // model-only rotation
    scene.add(pivot);

    let modelRoot = null;
    let cardGroup = null;

    function loadSound(file) {
      if (currentSound) currentSound.pause();
      const base = file.split('/').pop().replace('.glb', '');
      currentSound = new Audio(`sounds/${base}.mp3`);
    }

    function playSound() {
      if (!currentSound) return;
      currentSound.currentTime = 0;
      currentSound.play().catch(()=>{});
    }

    async function loadContent(file) {
      msg.style.display = "grid";

      if (modelRoot) pivot.remove(modelRoot);
      if (cardGroup) scene.remove(cardGroup);

      pivot.rotation.set(0,0,0);

      const base = file.split('/').pop().replace('.glb', '');

      const frontTex = await texLoader.loadAsync(`models/thumbnails/${base}.jpg`);
      const backTex  = await texLoader.loadAsync(`models/thumbnails/cardbacking.png`);

      // PHYSICAL CARD SIZE (ONE SIZE, BOTH SIDES)
      const w = 1;
      const h = w * (frontTex.image.height / frontTex.image.width);

      cardGroup = new THREE.Group();
      cardGroup.userData.isCard = true;

      const front = new THREE.Mesh(
        new THREE.PlaneGeometry(w, h),
        new THREE.MeshBasicMaterial({ map: frontTex })
      );

      const back = new THREE.Mesh(
        new THREE.PlaneGeometry(w, h),
        new THREE.MeshBasicMaterial({ map: backTex })
      );
      back.rotation.y = Math.PI;

      cardGroup.add(front, back);
      scene.add(cardGroup);

      if (showModel) {
        const gltf = await loader.loadAsync(file);
        modelRoot = gltf.scene;
        modelRoot.userData.isModel = true;

        const box = new THREE.Box3().setFromObject(modelRoot);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        modelRoot.position.sub(center);
        pivot.add(modelRoot);

        cardGroup.position.z = box.min.z - 0.1;
        cardGroup.scale.setScalar(size.y / h * 1.5);
      }

      loadSound(file);
      msg.style.display = "none";
    }

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    renderer.domElement.addEventListener("mouseup", e => {
      pointer.x = (e.clientX / innerWidth) * 2 - 1;
      pointer.y = -(e.clientY / innerHeight) * 2 + 1;
      raycaster.setFromCamera(pointer, camera);

      const hits = raycaster.intersectObjects(scene.children, true);
      if (!hits.length) return;

      let o = hits[0].object;
      let hitModel = false;
      let hitCard = false;

      while (o) {
        if (o.userData?.isModel) hitModel = true;
        if (o.userData?.isCard) hitCard = true;
        o = o.parent;
      }

      if ((showModel && hitModel) || (!showModel && hitCard)) {
        playSound();
      }
    });

    document.getElementById("toggleRotate").onclick = () => {
      autoRotate = !autoRotate;
      toggleRotate.textContent = `Rotate: ${autoRotate ? "ON" : "OFF"}`;
    };

    document.getElementById("toggleModel").onclick = () => {
      showModel = !showModel;
      toggleModel.textContent = showModel ? "Hide Model" : "Show Model";
      loadContent(MODEL_FILES[currentModelIndex]);
    };

    document.getElementById("reset").onclick = () => {
      pivot.rotation.set(0,0,0);
    };

    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      if (autoRotate && showModel) {
        pivot.rotation.y += clock.getDelta() * document.getElementById("speed").value;
      }
      renderer.render(scene, camera);
    }
    animate();

    async function init() {
      const res = await fetch('https://api.github.com/repos/pneumatic-steel/3D-viewer/contents/models');
      const data = await res.json();
      MODEL_FILES = data.filter(f => f.name.endsWith('.glb')).map(f => `models/${f.name}`);
      loadContent(MODEL_FILES[0]);
    }

    init();
  </script>
</body>
</html>
