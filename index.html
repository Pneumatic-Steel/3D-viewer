<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Model Viewer</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      background-color: #111;
      background-image: url('pokemonBackground.gif');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    #ui {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 10;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: rgba(0,0,0,0.55);
      padding: 10px 12px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
    }

    #ui h1 {
      font-size: 14px;
      margin: 0 0 6px 0;
      font-weight: 600;
    }

    #ui .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 6px;
    }

    #ui button {
      border: 0;
      border-radius: 8px;
      padding: 8px 10px;
      background: #2b2b2b;
      color: #fff;
      cursor: pointer;
    }

    #ui button:hover { background: #3a3a3a; }

    #modelCounter {
      font-size: 12px;
      opacity: 0.8;
    }

    #msg {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      color: #ddd;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    canvas {
      display: block;
      position: absolute;
      inset: 0;
      z-index: 2;
    }

    #menuButton {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 11;
    }

    #menuPanel {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 12;
      display: none;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }

    #menuGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }

    .menuTile img {
      width: 100%;
      border-radius: 8px;
      background: #1a1a1a;
      object-fit: contain;
      cursor: pointer;
    }

    .menuTile.selected img {
      box-shadow: 0 0 0 2px #fff;
    }
  </style>
</head>

<body>
  <div id="ui">
    <h1>3D Model Viewer</h1>
    <div class="row">
      <span id="modelCounter">Model</span>
    </div>
    <div class="row">
      <button id="reset">Reset View</button>
      <button id="toggleRotate">Auto-rotate: OFF</button>
      <button id="toggleModel">Hide Model</button>
      <label>Speed <input id="speed" type="range" min="0" max="2" step="0.01" value="0.6"></label>
    </div>
  </div>

  <button id="menuButton">â˜° Menu</button>

  <div id="menuPanel">
    <button id="menuClose">Close</button>
    <div id="menuGrid"></div>
  </div>

  <div id="msg">Loadingâ€¦</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    let MODEL_FILES = [];
    let currentModelIndex = 0;
    let currentSound = null;
    let showModel = true;

    const msg = document.getElementById("msg");

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(55, innerWidth / innerHeight, 0.01, 2000);
    camera.position.set(2.5, 1.7, 2.5);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const loader = new THREE.GLTFLoader();
    const textureLoader = new THREE.TextureLoader();

    const pivot = new THREE.Group();
    scene.add(pivot);

    let modelRoot = null;
    let cardGroup = null;

    function loadSound(filename) {
      if (currentSound) currentSound.pause();
      const base = filename.split('/').pop().replace('.glb', '');
      currentSound = new Audio(`sounds/${base}.mp3`);
    }

    function playSound() {
      if (!currentSound) return;
      currentSound.currentTime = 0;
      currentSound.play().catch(()=>{});
    }

    async function loadContent(filename) {
      msg.style.display = 'grid';

      if (modelRoot) pivot.remove(modelRoot);
      if (cardGroup) scene.remove(cardGroup);

      pivot.rotation.set(0,0,0);

      const base = filename.split('/').pop().replace('.glb', '');

      const frontTex = await textureLoader.loadAsync(`models/thumbnails/${base}.jpg`);
      const backTex  = await textureLoader.loadAsync(`models/thumbnails/cardbacking.png`);

      const frontAspect = frontTex.image.width / frontTex.image.height;
      const w = 1;
      const h = w / frontAspect;

      cardGroup = new THREE.Group();
      cardGroup.userData.isCard = true;

      const front = new THREE.Mesh(
        new THREE.PlaneGeometry(w, h),
        new THREE.MeshBasicMaterial({ map: frontTex })
      );

      const back = new THREE.Mesh(
        new THREE.PlaneGeometry(w, h),
        new THREE.MeshBasicMaterial({ map: backTex, transparent: true })
      );
      back.rotation.y = Math.PI;

      // ðŸ”¥ PHYSICAL CARD FIX â€” scale back image to match card
      const backAspect = backTex.image.width / backTex.image.height;
      if (backAspect > frontAspect) {
        back.scale.y = frontAspect / backAspect;
      } else {
        back.scale.x = backAspect / frontAspect;
      }

      cardGroup.add(front, back);
      scene.add(cardGroup);

      if (showModel) {
        const gltf = await loader.loadAsync(filename);
        modelRoot = gltf.scene;
        modelRoot.userData.isModel = true;

        const box = new THREE.Box3().setFromObject(modelRoot);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        modelRoot.position.sub(center);
        pivot.add(modelRoot);

        cardGroup.position.z = box.min.z - 0.1;
        cardGroup.scale.setScalar(size.y / h * 1.5);
      }

      loadSound(filename);
      msg.style.display = "none";
    }

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    renderer.domElement.addEventListener("mouseup", e => {
      pointer.x = (e.clientX / innerWidth) * 2 - 1;
      pointer.y = -(e.clientY / innerHeight) * 2 + 1;
      raycaster.setFromCamera(pointer, camera);

      const hits = raycaster.intersectObjects(scene.children, true);
      if (!hits.length) return;

      let o = hits[0].object;
      let hitModel = false;
      let hitCard = false;

      while (o) {
        if (o.userData?.isModel) hitModel = true;
        if (o.userData?.isCard) hitCard = true;
        o = o.parent;
      }

      if ((showModel && hitModel) || (!showModel && hitCard)) {
        playSound();
      }
    });

    let autoRotate = false;
    const speed = document.getElementById("speed");

    document.getElementById("toggleRotate").onclick = () => {
      autoRotate = !autoRotate;
      toggleRotate.textContent = `Auto-rotate: ${autoRotate ? "ON" : "OFF"}`;
    };

    document.getElementById("toggleModel").onclick = () => {
      showModel = !showModel;
      toggleModel.textContent = showModel ? "Hide Model" : "Show Model";
      loadContent(MODEL_FILES[currentModelIndex]);
    };

    const clock = new THREE.Clock();

    function animate() {
      requestAnimationFrame(animate);
      if (autoRotate && showModel) {
        pivot.rotation.y += clock.getDelta() * speed.value;
      }
      renderer.render(scene, camera);
    }

    animate();

    async function init() {
      const res = await fetch('https://api.github.com/repos/pneumatic-steel/3D-viewer/contents/models');
      const data = await res.json();
      MODEL_FILES = data.filter(f => f.name.endsWith('.glb')).map(f => `models/${f.name}`);
      loadContent(MODEL_FILES[0]);
    }

    init();
  </script>
</body>
</html>
